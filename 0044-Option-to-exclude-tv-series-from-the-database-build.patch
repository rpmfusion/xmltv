From f78958aaeea75341039cdfee9ee22f038061e6a3 Mon Sep 17 00:00:00 2001
From: Honir <honir@c4b.co.uk>
Date: Wed, 13 Jan 2021 18:23:24 +0000
Subject: [PATCH 44/50] Option to exclude tv-series from the database build

---
 filter/tv_imdb | 7 ++++++-
 lib/IMDB.pm    | 4 ++++
 2 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/filter/tv_imdb b/filter/tv_imdb
index 859d6c57..d9e660d4 100755
--- a/filter/tv_imdb
+++ b/filter/tv_imdb
@@ -9,7 +9,7 @@ tv_imdb - Augment XMLTV listings files with imdb.com data.
 =head1 SYNOPSIS
 
 tv_imdb --imdbdir <dir> [--help] [--quiet] [--download]
-       [--filesort] [--nosystemsort]
+       [--movies-only] [--filesort] [--nosystemsort]
        [--prepStage (1-9,all)]
 
 tv_imdb --imdbdir <dir> [--help] [--quiet]
@@ -125,6 +125,10 @@ can use the File::Sort package if it is installed on your system, by also adding
 option --nosystemsort (however this method of sorting is very slow). If you specify 
 neither option then Perl will sort the files in memory.
 
+If you are only interested in movies, you can reduce the memory required and the 
+size of the database by passing the --movies-only option to the database build,
+which will exclude tv-series from the database.
+
 B<3.> Once you have the database loaded try
 E<39>cat tv.xml | tv_imdb --imdbdir <dir> > tv1.xmlE<39>.
 
@@ -284,6 +288,7 @@ END
 		 'sample' 					=> $opt_sample,
 		 'filesort'					=> $opt_filesort,
 		 'systemsort'				=> $opt_systemsort,
+		 'moviesonly'				=> $opt_movies_only,
 		);
 
 	if ( $opt_prepStage eq "all" ) {
diff --git a/lib/IMDB.pm b/lib/IMDB.pm
index 3ee44c7a..7db3c981 100644
--- a/lib/IMDB.pm
+++ b/lib/IMDB.pm
@@ -55,6 +55,7 @@ use open ':encoding(iso-8859-1)';   # try to enforce file encoding (does this wo
 #			  (potentially wrong - it should not augment incoming prog when multiple matches)
 #		dbbuild: --filesort to sort interim data on disc rather than in memory
 #		dbbuild: --nosystemsort to use File::Sort rather than operating system shell's 'sort' command
+#		dbbuild: --movies-only to exclude tv-series (etc.) from database build
 #
 #
 our $VERSION = '0.11';	  # version number of database
@@ -1941,6 +1942,8 @@ sub readMovies($$$$$)
 			# we don't keep episode information   TODO: enhancement: change tv_imdb to do episodes?
 			if ($isepisode == 1) { next; }
 			
+			next if ($self->{moviesonly} && ($progtype != 1 && $progtype != 2) );	# user requested movies_only
+			
 			
 			# store the movies data
 			if ($self->{usefilesort}) {
@@ -2179,6 +2182,7 @@ sub readCastOrDirectors($$$$$)
 				##  often where the year on the actor record is 1 year out
 				##  people will get worried if we report over 1000 errors and there's nothing we can sensibly do about them
 				##$self->error("$file:$lineCount: cannot find $title in titles list");
+				###   if we reinstate this test then we'd need to allow for 'moviesonly' option (i.e. a lot of titles will have been deliberately excluded)
 				next;
 			}
 
-- 
2.29.2

